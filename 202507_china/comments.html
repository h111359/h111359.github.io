<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery & Text Blocks Editor</title>
  <style>
    :root {
      --bg: #0b0e13; --panel: #11151c; --muted: #7a8699; --text: #eef3f8;
      --accent: #4cc9f0; --danger: #ff6b6b; --ok: #6ef3a5; --border: #1e2530;
    }
    html, body { height: 100%; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text); background: radial-gradient(1200px 800px at 80% -10%, #132033, var(--bg)); }
    header { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(17,21,28,.8), rgba(17,21,28,.4)); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px 16px; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .desc { color: var(--muted); font-size: 13px; }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    .section { padding: 16px; }
    .section + .section { border-top: 1px dashed var(--border); }

    textarea.input {
      width: 100%; min-height: 180px; resize: vertical; padding: 12px; border-radius: 10px;
      border: 1px solid var(--border); background: #0f131a; color: var(--text);
      font: 13px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }

    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      border: 1px solid var(--border); background: #121824; color: var(--text);
      padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px;
    }
    button:hover { background: #151e2e; border-color: #2a3446; }
    .primary { border-color: transparent; background: linear-gradient(135deg, var(--accent), #9b5cf6); color: #001219; }
    .success { background: linear-gradient(135deg, var(--ok), #9bffdd); color: #062a12; border-color: transparent; }
    .muted { color: var(--muted); }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
    .media { display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #0f141d; border: 1px solid var(--border); border-radius: 12px; }
    .media .head { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .media .name { font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .media .name b { color: var(--text); }
    .media iframe, .media img, .media video {
      width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); background: #0a0f16;
    }

    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; background: #0f141d; border: 1px solid var(--border); font-size: 12px; color: var(--muted); }
    .pill input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); }

    .field { display: grid; gap: 6px; }
    .label { font-size: 11px; color: var(--muted); }
    .text, .area {
      width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #0a0f16; color: var(--text);
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .area { min-height: 60px; resize: vertical; }
    .body { min-height: 120px; }

    .footer { display: grid; gap: 8px; }
    .out { width: 100%; min-height: 160px; white-space: pre; }
    .tiny { font-size: 11px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Gallery & Text Blocks Editor</h1>
      <div class="desc">
        Paste your <code>window.GALLERY_ITEMS = [ ... ]</code> (or just the array). Supports
        <b>media</b> items (<code>{ name, preview, desc }</code>) and <b>text</b> blocks
        (<code>{ type: "text", title, body, desc }</code>) anywhere in the list. Toggle include, edit fields, and get a regenerated list below.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="section">
        <div class="row" style="align-items:start;">
          <textarea id="src" class="input" placeholder="Paste here..."></textarea>
          <div class="controls">
            <button id="load" class="primary">Load Items</button>
            <button id="sample">Sample</button>
            <button id="clear">Clear</button>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">
          Tip: We accept the full assignment (e.g. <code>window.GALLERY_ITEMS = [ ... ];</code>) or just the array. Unquoted keys OK.
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="muted">Rendered items</div>
          <div class="controls">
            <span class="pill"><input type="checkbox" id="allToggle" checked/> Toggle all</span>
            <button id="regenerate" class="success">Regenerate Output</button>
          </div>
        </div>
        <div id="grid" class="grid" aria-live="polite"></div>
      </div>

      <div class="section footer">
        <div class="row">
          <div class="muted">Resulting list</div>
          <div class="controls">
            <button id="copy" class="primary">Copy</button>
            <button id="download">Download .js</button>
            <span id="status" class="tiny"></span>
          </div>
        </div>
        <textarea id="out" class="input out" readonly></textarea>
        <div class="tiny">
          Unchecked items are <b>commented</b> out in the output. Media rows use their <code>desc</code>;
          text blocks include <code>type</code>, <code>title</code>, <code>body</code>, and <code>desc</code>.
        </div>
      </div>
    </div>
  </main>

  <script>
    const byId = (id) => document.getElementById(id);
    const src = byId('src');
    const grid = byId('grid');
    const out = byId('out');
    const status = byId('status');

    const SAMPLE = `window.GALLERY_ITEMS = [
  { type: "text", title: "Ден първи", body: "Първият посетен обект беше Храмът на Нефритения Буда в Шанхай - едно от най-свещените будистки места в Китай и истински духовен оазис в сърцето на мегаполиса. Построен през 1882 г., той приютява две изключителни нефритени статуи на Буда, донесени от монаха Хуиген след поклонничество в Бирма. Будизмът в Китай съчетава елементи от махаяна традицията и местни вярвания, като акцентира върху състраданието, мъдростта и стремежа към хармония.", desc: "Бележка" },
  { name: "20250721_180222.jpg", preview: "https://drive.google.com/file/d/1xvpiwUPikjLHbelx5GLxvqMELYtZwu6s/preview?authuser=0", desc: "Снимка – временно описание." },
  { name: "20250721_193611.mp4", preview: "https://drive.google.com/file/d/1cCYAzAWaCQehku8F7hzJwZz0SJusPXBk/preview?authuser=0", desc: "Видео – временно описание." },
  { type: "text", title: "Край", body: "Финален текстов блок.", desc: "" }
];`;

    byId('sample').addEventListener('click', () => { src.value = SAMPLE; });
    byId('clear').addEventListener('click', () => { src.value = ''; grid.innerHTML = ''; out.value = ''; status.textContent=''; });

    function tryParseItems(text) {
      if (!text || !text.trim()) return [];
      const first = text.indexOf('[');
      const last = text.lastIndexOf(']');
      let arrStr = text;
      if (first !== -1 && last !== -1 && last > first) arrStr = text.slice(first, last + 1);
      // Quote object-literal keys + strip trailing commas
      arrStr = arrStr.replace(/([{\,]\s*)([a-zA-Z_$][\w$]*)\s*:/g, '$1"$2":');
      arrStr = arrStr.replace(/,(\s*[}\]])/g, '$1');

      try {
        const raw = JSON.parse(arrStr);
        if (!Array.isArray(raw)) throw new Error('Parsed value is not an array');
        return raw.map((it, idx) => {
          if (it.type === 'text') {
            return { _kind: 'text', type: String(it.type || 'text'), title: String(it.title || ''), body: String(it.body || ''), desc: String(it.desc || ''), _checked: true, _id: idx };
          }
          return { _kind: 'media', name: String(it.name || ''), preview: String(it.preview || ''), desc: String(it.desc || ''), _checked: true, _id: idx };
        });
      } catch (e) {
        throw new Error('Could not parse the list. Expect media { name, preview, desc } and/or text blocks { type: "text", title, body, desc }. Details: ' + e.message);
      }
    }

    function mediaElementFor(item) {
      const lowerName = (item.name || '').toLowerCase();
      const isVideo = lowerName.endsWith('.mp4') || /[?&]format=mp4/.test(item.preview || '');
      const isDrivePreview = /\/preview(\?|$)/.test(item.preview || '');
      if (isDrivePreview) {
        const ifr = document.createElement('iframe');
        ifr.src = item.preview; ifr.allow = 'autoplay; encrypted-media'; ifr.loading = 'lazy'; ifr.referrerPolicy = 'no-referrer';
        ifr.title = item.name || '';
        return ifr;
      }
      if (isVideo) {
        const v = document.createElement('video');
        v.src = item.preview; v.controls = true; v.playsInline = true; v.preload = 'metadata';
        return v;
      }
      const img = document.createElement('img');
      img.src = item.preview; img.alt = item.name || ''; img.loading = 'lazy';
      return img;
    }

    function render(items) {
      grid.innerHTML = '';
      items.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'media';
        card.dataset.kind = item._kind;

        const head = document.createElement('div');
        head.className = 'head';
        const left = document.createElement('div');
        left.className = 'name';

        const pill = document.createElement('label');
        pill.className = 'pill';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = item._checked !== false;
        cb.addEventListener('change', () => { item._checked = cb.checked; regenerate(items); });
        pill.append(cb, document.createTextNode(' include'));

        if (item._kind === 'text') {
          left.innerHTML = `<b>Text block</b> — <span class="muted">${escapeHtml(item.title || 'Untitled')}</span>`;
          head.append(left, pill);

          // TYPE
          const typeField = field('Type', 'text', item.type || 'text');
          typeField.input.addEventListener('input', () => { item.type = typeField.input.value; throttleRegenerate(items); });

          // TITLE
          const titleField = field('Title', 'text', item.title || '');
          titleField.input.addEventListener('input', () => { item.title = titleField.input.value; throttleRegenerate(items); });

          // BODY
          const bodyField = field('Body', 'area', item.body || '');
          bodyField.input.classList.add('body');
          bodyField.input.addEventListener('input', () => { item.body = bodyField.input.value; throttleRegenerate(items); });

          // DESC
          const descField = field('Desc (note)', 'area', item.desc || '');
          descField.input.addEventListener('input', () => { item.desc = descField.input.value; throttleRegenerate(items); });

          card.append(head, typeField.el, titleField.el, bodyField.el, descField.el);
        } else {
          left.innerHTML = `<b>${escapeHtml(item.name || 'Unnamed')}</b>`;
          head.append(left, pill);

          const media = mediaElementFor(item);
          const descField = field('Description', 'area', item.desc || '');
          descField.input.addEventListener('input', () => { item.desc = descField.input.value; throttleRegenerate(items); });

          card.append(head, media, descField.el);
        }
        grid.append(card);
      });
      regenerate(items);
    }

    function field(label, kind, value) {
      const wrap = document.createElement('div'); wrap.className = 'field';
      const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = label;
      let input;
      if (kind === 'area') {
        input = document.createElement('textarea'); input.className = 'area';
      } else {
        input = document.createElement('input'); input.type = 'text'; input.className = 'text';
      }
      input.value = value || '';
      wrap.append(lab, input);
      return { el: wrap, input };
    }

    function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function jsStringEscape(str) { return String(str).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/\r/g,'').replace(/\t/g,'\\t').replace(/\"/g,'\\"'); }

    function buildOutput(items) {
      const lines = [];
      lines.push('window.GALLERY_ITEMS = [');
      items.forEach((it, idx) => {
        let line = '';
        if (it._kind === 'text') {
          // Use user-edited type/title/body/desc
          line = `  { type: "${jsStringEscape(it.type || 'text')}", title: "${jsStringEscape(it.title || '')}", body: "${jsStringEscape(it.body || '')}", desc: "${jsStringEscape(it.desc || '')}" }`;
        } else {
          line = `  { name: "${jsStringEscape(it.name || '')}", preview: "${jsStringEscape(it.preview || '')}", desc: "${jsStringEscape(it.desc || '')}" }`;
        }
        lines.push((it._checked === false ? '  // ' : '  ') + line + (idx < items.length - 1 ? ',' : ''));
      });
      lines.push('];');
      return lines.join('\n');
    }

    let regenTimer = null;
    function throttleRegenerate(itemsRef) {
      if (regenTimer) cancelAnimationFrame(regenTimer);
      regenTimer = requestAnimationFrame(() => { regenerate(itemsRef); });
    }

    function regenerate(items) {
      const txt = buildOutput(items);
      out.value = txt;
      status.textContent = `Items: ${items.filter(i=>i._checked!==false).length} included / ${items.length} total`;
    }

    // Toggle all
    byId('allToggle').addEventListener('change', (e) => {
      const c = e.target.checked;
      document.querySelectorAll('.media input[type="checkbox"]').forEach(cb => { cb.checked = c; cb.dispatchEvent(new Event('change')); });
    });

    // Actions
    byId('load').addEventListener('click', () => {
      try {
        const items = tryParseItems(src.value);
        if (!items.length) { alert('No items found.'); return; }
        render(items);
      } catch (err) {
        alert(err.message);
      }
    });

    byId('regenerate').addEventListener('click', () => {
      const items = [];
      grid.querySelectorAll('.media').forEach((card) => {
        const include = card.querySelector('input[type="checkbox"]').checked;
        const kind = card.dataset.kind || 'media';

        if (kind === 'text') {
          const inputs = card.querySelectorAll('.field .text, .field .area');
          const type = inputs[0]?.value || 'text';
          const title = inputs[1]?.value || '';
          const body = inputs[2]?.value || '';
          const desc = inputs[3]?.value || '';
          items.push({ _kind: 'text', type, title, body, desc, _checked: include });
        } else {
          const name = card.querySelector('.name b')?.textContent || '';
          const desc = card.querySelector('.field .area')?.value || '';
          let preview = '';
          const ifr = card.querySelector('iframe');
          const img = card.querySelector('img');
          const vid = card.querySelector('video');
          if (ifr) preview = ifr.src; else if (img) preview = img.src; else if (vid) preview = vid.currentSrc || vid.src;
          items.push({ _kind: 'media', name, preview, desc, _checked: include });
        }
      });
      regenerate(items);
    });

    byId('copy').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(out.value);
        flash('Copied to clipboard');
      } catch {
        out.select(); document.execCommand('copy'); flash('Copied (fallback)');
      }
    });

    byId('download').addEventListener('click', () => {
      const blob = new Blob([out.value], { type: 'application/javascript;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gallery-items.js';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
    });

    function flash(msg) { status.textContent = msg; setTimeout(()=>status.textContent='', 1500); }
  </script>
</body>
</html>
